name: Build Portable Environments

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    name: Build env for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform_name: linux_x86_64
            python_download_url: "https://github.com/indygreg/python-build-standalone/releases/download/20230507/cpython-3.9.16+20230507-x86_64-unknown-linux-gnu-install_only.tar.gz"
          - os: macos-latest
            platform_name: macos_x86_64
            python_download_url: "https://github.com/indygreg/python-build-standalone/releases/download/20230507/cpython-3.9.16+20230507-x86_64-apple-darwin-install_only.tar.gz"
          # For M1/M2 Mac (ARM), you would add another entry if runners are available or cross-compile (complex).
          # For now, Rosetta handles x86_64 on M1 pretty well, but native is better.
          # GitHub Actions M1 runners are "macos-14".
          - os: macos-14
            platform_name: macos_aarch64
            python_download_url: "https://github.com/indygreg/python-build-standalone/releases/download/20230507/cpython-3.9.16+20230507-aarch64-apple-darwin-install_only.tar.gz"
          - os: windows-latest
            platform_name: win32_AMD64
            python_download_url: "https://github.com/indygreg/python-build-standalone/releases/download/20230507/cpython-3.9.16+20230507-x86_64-pc-windows-msvc-shared-install_only.tar.gz"

    steps:
      - uses: actions/checkout@v3

      - name: Download and Extract Python
        continue-on-error: false
        run: |
           # Universal download/extract logic using python on runner or shell
           curl -L -o python.tar.gz "${{ matrix.python_download_url }}"
           mkdir python_env
           tar -xzf python.tar.gz -C python_env --strip-components=1

      - name: Install Dependencies
        run: |
          # Use the extracted python to install deps
          # Note: On Windows bash, paths might be tricky, but usually ./python/python.exe works
          
          if [ "${{ runner.os }}" == "Windows" ]; then
             ./python_env/python.exe -m pip install -r requirements.txt --target ./python_env/Lib/site-packages
             # Note: Using --target can be safer for portable builds to keep everything contained
             # But Indygreg builds usually have a working pip. Let's try direct install.
             ./python_env/python.exe -m pip install -r requirements.txt
          else
             chmod +x ./python_env/bin/python3
             ./python_env/bin/python3 -m pip install -r requirements.txt
          fi

      - name: Cleanup
        run: |
           # Remove bulky tests or cache if wanted
           rm python.tar.gz

      - name: Zip Environment
        run: |
          # Create the final zip
          if [ "${{ runner.os }}" == "Windows" ]; then
             7z a -tzip python_env_${{ matrix.platform_name }}.zip ./python_env/*
          else
             cd python_env
             zip -r ../python_env_${{ matrix.platform_name }}.zip .
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: python_env_${{ matrix.platform_name }}
          path: python_env_${{ matrix.platform_name }}.zip

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v3
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            python_env_linux_x86_64/python_env_linux_x86_64.zip
            python_env_macos_x86_64/python_env_macos_x86_64.zip
            python_env_macos_aarch64/python_env_macos_aarch64.zip
            python_env_win32_AMD64/python_env_win32_AMD64.zip
